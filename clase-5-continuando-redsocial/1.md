# Código SQL 

## Base de datos
```sql
USE RedSocial;
```

## Consultas básicas

### 1. Seleccionar todos los usuarios
```sql
SELECT * FROM users;
```

### 2. Buscar emails de Google
```sql
SELECT email FROM users WHERE email LIKE '%@google.com';
```

### 3. Contar emails de Google y agrupar
```sql
SELECT email, count(*) FROM users WHERE email LIKE '%@google.com' GROUP BY email;
```

## Resultados esperados
```
-- sofia@google.com
-- catalina@google.com
-- richard@google.com
-- andres@google.com
```

## Funciones de cadenas - SUBSTRING

### Extraer parte del email (desde posición 6, 11 caracteres)
```sql
SELECT SUBSTRING('sofia@google.com', 6, 11);
SELECT SUBSTRING('catalina@google.com', 6, 11);
SELECT SUBSTRING('andres@google.com', 6, 11);
```

## Funciones de cadenas - CHARINDEX

### Encontrar posición del '@' en emails
```sql
SELECT CHARINDEX('@', 'catalina@google.com') + 1;
SELECT CHARINDEX('@', 'sofia@google.com') + 1;
```

## Funciones de cadenas - LEN

### Obtener longitud de emails
```sql
SELECT LEN(email) FROM users;
SELECT LEN('sofia@google.com');
SELECT LEN('catalina@google.com');
```

### Verificar longitud del email vs posición del '@'
```sql
SELECT CHARINDEX('@', 'sofia@google.com');
SELECT CHARINDEX('@', 'catalina@google.com');
SELECT CHARINDEX('@', 'angel@gnu.org');
SELECT LEN('angel@gnu.org');
```

## Resultados de cálculos
```
-- 13 - 6 = 7
-- 16 - 6 = 10
-- 19 - 9 = 10
```

## Fórmula completa: Extraer dominio del email

### Calcular longitud del dominio dinámicamente
```sql
SELECT LEN(email) - CHARINDEX('@', email) FROM users;
```

**Explicación:**
- `LEN(email)` → longitud total del email
- `CHARINDEX('@', email)` → posición del '@'
- La resta da la cantidad de caracteres después del '@' (el dominio)

---

## Aplicación práctica completa

### Extraer dominio de todos los emails
```sql
SELECT 
    email,
    SUBSTRING(email, CHARINDEX('@', email) + 1, LEN(email) - CHARINDEX('@', email)) AS dominio
FROM users;
```

### Contar usuarios por dominio
```sql
SELECT 
    SUBSTRING(email, CHARINDEX('@', email) + 1, LEN(email) - CHARINDEX('@', email)) AS dominio,
    COUNT(*) AS total
FROM users
GROUP BY SUBSTRING(email, CHARINDEX('@', email) + 1, LEN(email) - CHARINDEX('@', email))
ORDER BY total DESC;
```

### Versión mejorada con CTE (más legible)
```sql
WITH DominiosEmail AS (
    SELECT 
        email,
        SUBSTRING(email, CHARINDEX('@', email) + 1, LEN(email)) AS dominio
    FROM users
)
SELECT 
    dominio,
    COUNT(*) AS total
FROM DominiosEmail
GROUP BY dominio
HAVING COUNT(*) > 1
ORDER BY dominio ASC;
```

---

## Notas importantes

1. **SUBSTRING(cadena, inicio, longitud)**
   - `inicio`: posición inicial (1-based)
   - `longitud`: cantidad de caracteres a extraer

2. **CHARINDEX(buscar, cadena)**
   - Devuelve la posición de la primera aparición
   - Devuelve 0 si no encuentra nada

3. **LEN(cadena)**
   - Devuelve la longitud total de la cadena
   - No cuenta espacios al final (trailing spaces)

4. **Fórmula del dominio:**
   - Inicio: `CHARINDEX('@', email) + 1` (después del '@')
   - Longitud: `LEN(email) - CHARINDEX('@', email)` (todo lo que sigue al '@')

---

## Consulta completa con GROUP BY repetido (método original)

```sql
SELECT 
    COUNT(*) AS total,
    SUBSTRING(email, CHARINDEX('@', email) + 1, LEN(email) - CHARINDEX('@', email)) AS Domain
FROM users
GROUP BY SUBSTRING(email, CHARINDEX('@', email) + 1, LEN(email) - CHARINDEX('@', email))
HAVING COUNT(*) > 1;
```

**Problema:** La expresión SUBSTRING se repite, difícil de mantener.

---

## Solución mejorada: CTE (Common Table Expression)

```sql
WITH DominiosEmail AS (
    SELECT SUBSTRING(email, CHARINDEX('@', email) + 1, LEN(email) - CHARINDEX('@', email)) AS Domain
    FROM users
)
SELECT 
    Domain, 
    COUNT(*) AS Total
FROM DominiosEmail
GROUP BY Domain
HAVING COUNT(*) > 1
ORDER BY Domain ASC;
```

**Ventajas:**
- ✅ No repites la expresión compleja
- ✅ Más fácil de leer y mantener
- ✅ Puedes agregar más columnas sin duplicar código
- ✅ El alias `Domain` se puede usar en GROUP BY, HAVING y ORDER BY

---

## Funciones TRIM, LTRIM, RTRIM

### TRIM - Eliminar espacios en ambos lados

```sql
-- trim() disponible en JAVA, PHP, JAVASCRIPT
SELECT TRIM('   Hola Mundo   ') AS Resultado;
-- Resultado: 'Hola Mundo'
```

### TRIM con cadena específica

```sql
SELECT TRIM('.' FROM '...sofia...') AS Resultado;
-- Resultado: 'sofia'
```

### LTRIM - Eliminar espacios a la izquierda (Left)

```sql
SELECT LTRIM('   sofia') AS LeftClean;
-- Resultado: 'sofia'
```

### RTRIM - Eliminar espacios a la derecha (Right)

```sql
SELECT RTRIM('sofia   ') AS RightClean;
-- Resultado: 'sofia'
```

### LTRIM + RTRIM - Equivalente a TRIM (versiones antiguas SQL Server)

```sql
SELECT LTRIM(RTRIM('   Hola Mundo   ')) AS Ambos;
-- Resultado: 'Hola Mundo'
```

---

## Aplicación práctica de TRIM en BibliotecaDB234

### Limpiar datos de socios

```sql
-- Limpiar nombres y emails con espacios no deseados
UPDATE Socios
SET 
    Nombre = TRIM(Nombre),
    Apellido = TRIM(Apellido),
    Email = TRIM(Email)
WHERE 
    Nombre != TRIM(Nombre) 
    OR Apellido != TRIM(Apellido)
    OR Email != TRIM(Email);
```

### Buscar datos con espacios (datos sucios)

```sql
SELECT 
    SocioID,
    '[' + Nombre + ']' AS NombreConEspacios,
    TRIM(Nombre) AS NombreLimpio
FROM Socios
WHERE Nombre != TRIM(Nombre) OR Apellido != TRIM(Apellido);
```

### Validar emails sin espacios al insertar

```sql
INSERT INTO Socios (Nombre, Apellido, Email, FechaRegistro)
VALUES 
(TRIM('  Ana  '), TRIM(' Torres '), TRIM(' ana.torres@email.com '), GETDATE());
```

---

## Resumen de funciones de cadenas

| Función | Descripción | Ejemplo |
|---------|-------------|---------|
| `SUBSTRING(str, start, len)` | Extrae parte de una cadena | `SUBSTRING('Hola', 1, 2)` → 'Ho' |
| `CHARINDEX(buscar, str)` | Encuentra posición de subcadena | `CHARINDEX('@', 'a@b.com')` → 2 |
| `LEN(str)` | Longitud de la cadena | `LEN('Hola')` → 4 |
| `TRIM(str)` | Elimina espacios ambos lados | `TRIM('  Hola  ')` → 'Hola' |
| `LTRIM(str)` | Elimina espacios izquierda | `LTRIM('  Hola')` → 'Hola' |
| `RTRIM(str)` | Elimina espacios derecha | `RTRIM('Hola  ')` → 'Hola' |

---

## Buenas prácticas

1. **Usa CTE** para consultas complejas con expresiones repetidas
2. **Limpia datos** con TRIM al insertar o actualizar
3. **Valida datos** antes de guardarlos en la base de datos
4. **Combina funciones** para soluciones más potentes:
   ```sql
   -- Extraer dominio limpio
   SELECT TRIM(SUBSTRING(email, CHARINDEX('@', email) + 1, LEN(email))) AS DominioLimpio
   FROM users;
   ```
